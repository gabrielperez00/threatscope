<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ThreatScope</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Navbar -->
  <nav class="bg-gray-900 text-white p-4 flex justify-between">
    <div class="font-bold text-lg">ThreatScope</div>
    <div class="space-x-4">
      <a href="/" class="hover:underline">Dashboard</a>
      <a href="/map" class="hover:underline">Map</a>
      <a href="/rules" class="hover:underline">Rules</a>
      <a href="/hunts" class="hover:underline">Hunts</a>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-4">

    <!-- Findings Table -->
    <section class="bg-white p-4 shadow rounded mb-8 overflow-x-auto">
      <h2 class="text-lg font-semibold mb-4">Latest Findings</h2>
      <table class="table-auto w-full text-sm">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="px-2 py-1">Timestamp</th>
            <th class="px-2 py-1">Host</th>
            <th class="px-2 py-1">User</th>
            <th class="px-2 py-1">Source IP</th>
            <th class="px-2 py-1">Action</th>
            <th class="px-2 py-1">Details</th>
            <th class="px-2 py-1">Severity</th>
          </tr>
        </thead>
        <tbody>
          {% for f in latest %}
          <tr class="border-b">
            <td class="px-2 py-1">{{ f.ts }}</td>
            <td class="px-2 py-1">{{ f.host }}</td>
            <td class="px-2 py-1">{{ f.user }}</td>
            <td class="px-2 py-1">{{ f.src_ip }}</td>
            <td class="px-2 py-1">{{ f.action }}</td>
            <td class="px-2 py-1">{{ f.details }}</td>
            <td class="px-2 py-1">
              {% if f.severity == "high" %}
                <span class="bg-red-500 text-white text-xs px-2 py-1 rounded">High</span>
              {% elif f.severity == "medium" %}
                <span class="bg-yellow-500 text-black text-xs px-2 py-1 rounded">Medium</span>
              {% elif f.severity == "low" %}
                <span class="bg-green-500 text-white text-xs px-2 py-1 rounded">Low</span>
              {% else %}
                <span class="bg-gray-400 text-white text-xs px-2 py-1 rounded">Info</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- Findings by Rule Chart -->
    <section class="bg-white p-4 shadow rounded">
      <h2 class="text-lg font-semibold mb-4">Findings by Rule</h2>
      <div class="h-80">
        <canvas id="ruleChart"></canvas>
      </div>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script>
    window.tsCharts = window.tsCharts || {};
    (async function () {
      try {
        const el = document.getElementById('ruleChart');
        if (!el) return;
        const ctx = el.getContext('2d');

        if (window.tsCharts.ruleChart && typeof window.tsCharts.ruleChart.destroy === 'function') {
          window.tsCharts.ruleChart.destroy();
        }

        const res = await fetch('/stats');
        const data = await res.json();
        const labels = (data.by_rule || []).map(x => x.rule);
        const counts = (data.by_rule || []).map(x => x.count);

        window.tsCharts.ruleChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'Findings', data: counts }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, precision: 0 } },
            plugins: { legend: { display: false } }
          }
        });
      } catch (e) {
        console.error('stats fetch failed', e);
      }
    })();
  </script>
</body>
</html>
