<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ThreatScope â€“ Map</title>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #map { height: 75vh; min-height: 420px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="border-b bg-gray-900 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex gap-4 items-center">
      <a href="/" class="font-semibold">ThreatScope</a>
      <nav class="text-sm space-x-4">
        <a href="/" class="opacity-90 hover:opacity-100">Home</a>
        <a href="/hunt" class="opacity-90 hover:opacity-100">Hunt</a>
        <a href="/map" class="opacity-100 underline">Map</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-semibold mb-4">Event Map</h1>
    <div id="map" class="bg-white shadow rounded"></div>
  </main>

  <script>
    const map = L.map('map').setView([28.538, -81.379], 6); // start around Florida
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

    fetch('/events_geo')
      .then(r => r.json())
      .then(rows => {
        if (!Array.isArray(rows) || rows.length === 0) return;
        const group = L.featureGroup();
        rows.forEach(r => {
          const m = L.marker([r.lat, r.lon]).bindPopup(
            `<b>${r.user}@${r.host}</b><br/>${r.action}<br/><span style="font-size:12px">${r.ts}</span><br/>${r.details || ''}`
          );
          group.addLayer(m);
        });
        group.addTo(map);
        map.fitBounds(group.getBounds().pad(0.2));
      })
      .catch(e => console.error(e));
  </script>
</body>
</html>
